<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ“Š Member Profile - FitZone</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700;900&family=Poppins:wght@600;700;900&display=swap" rel="stylesheet">
    <style>
        * { margin:0; padding:0; box-sizing:border-box; }

        body {
            font-family:'Roboto',sans-serif;
            background:linear-gradient(135deg,#0f0f1e,#1a1a3e);
            color:#fff;
            min-height:100vh;
            padding:20px;
        }

        .container { max-width:1100px; margin:auto; }

        .back-link {
            display:inline-block;
            margin-bottom:30px;
            padding:12px 25px;
            background:rgba(255,107,53,.2);
            border:1px solid #ff6b35;
            color:#ff6b35;
            border-radius:8px;
            text-decoration:none;
            font-weight:bold;
        }
        .back-link:hover { background:#ff6b35;color:#fff }

        header {
            text-align:center;
            margin-bottom:40px;
            border-bottom:3px solid #ff6b35;
            padding-bottom:20px;
        }

        h1 {
            font-size:2.5em;
            color:#ff6b35;
            font-family:'Poppins',sans-serif;
        }

        .member-avatar {
            width:120px;height:120px;border-radius:50%;
            background:linear-gradient(135deg,#ff6b35,#ff8560);
            display:flex;align-items:center;justify-content:center;
            font-size:3em;margin:20px auto;
        }

        .action-btns {
            display:grid;
            grid-template-columns:1fr 1fr;
            gap:15px;
            margin-bottom:40px;
        }

        .btn-primary {
            padding:15px;
            background:linear-gradient(135deg,#ff6b35,#ff8560);
            border:none;border-radius:8px;
            color:#fff;font-weight:bold;
            cursor:pointer;text-align:center;
            text-decoration:none;
            transition:all 0.3s ease;
        }
        
        .btn-primary:hover {
            transform:translateY(-2px);
            box-shadow:0 8px 20px rgba(255,107,53,0.4);
        }
        
        .btn-primary.remove-btn {
            background:linear-gradient(135deg,#ff4343,#ff6666);
        }
        
        .btn-primary.remove-btn:hover {
            box-shadow:0 8px 20px rgba(255,67,67,0.4);
        }

        .profile-grid {
            display:grid;
            grid-template-columns:1fr 1fr;
            gap:30px;
            margin-bottom:40px;
        }

        .card, .section {
            background:rgba(255,255,255,.08);
            border:1px solid rgba(255,107,53,.3);
            border-radius:15px;
            padding:25px;
            margin-bottom:30px;
        }

        .card h3, .section h4 {
            color:#ff6b35;
            margin-bottom:20px;
        }

        .info-row {
            display:flex;
            justify-content:space-between;
            padding:10px 0;
            border-bottom:1px solid rgba(255,107,53,.15);
        }

        .recent-list { display:flex;flex-direction:column;gap:10px }

        .list-item {
            display:flex;justify-content:space-between;
            padding:12px;background:rgba(0,0,0,.3);
            border-radius:8px;
        }

        footer {
            text-align:center;
            padding:30px 0;
            color:#a0a0a0;
            border-top:2px solid rgba(255,107,53,.3);
        }

        @media(max-width:768px){
            .profile-grid,.action-btns{grid-template-columns:1fr}
            h1{font-size:1.8em}
        }
    </style>
</head>
<body>
<div class="container">

    <a href="/" class="back-link">â† Back to Dashboard</a>

    {% if member %}
    <header>
        <h1>ğŸ’ª {{ member.name }}'s Profile</h1>
        <div class="member-avatar">{{ member.name[0].upper() }}</div>
    </header>

    <!-- QUICK ACTIONS -->
    <div class="action-btns">
        <a href="/attendance/{{ member.id }}" class="btn-primary">âœ… Mark Attendance</a>
        <a href="#add-fee" class="btn-primary">ğŸ’³ Add Fee</a>
        <a href="#weight-section" class="btn-primary" style="grid-column:span 1;">âš–ï¸ Track Weight</a>
        <button class="btn-primary remove-btn" onclick="if(confirm('Are you sure you want to remove this member from the gym?')) { document.getElementById('removeMemberForm').submit(); }">ğŸ—‘ï¸ Remove Member</button>
    </div>
    
    <!-- Hidden form for removing member -->
    <form id="removeMemberForm" action="/remove-member/{{ member.id }}" method="POST" style="display:none;"></form>

    <!-- MEMBER INFO -->
    <div class="profile-grid">
        <div class="card">
            <h3>ğŸ“‹ Personal Info</h3>
            <div class="info-row"><span>Name</span><span>{{ member.name }}</span></div>
            <div class="info-row"><span>Phone</span><span>{{ member.phone or 'â€”' }}</span></div>
            <div class="info-row"><span>Email</span><span>{{ member.email or 'â€”' }}</span></div>
            <div class="info-row"><span>Joined</span><span>{{ member.join_date }}</span></div>
            <div class="info-row"><span>Status</span><span>{{ member.status }}</span></div>
        </div>

        <div class="card">
            <h3>ğŸ“Š Attendance Stats</h3>
            {% for s,c in attendance_data %}
            <div class="info-row"><span>{{ s }}</span><span>{{ c }} days</span></div>
            {% else %}
            <p style="color:#a0a0a0;">No attendance data</p>
            {% endfor %}
        </div>
    </div>

    <!-- ADD FEE SECTION (IMPORTANT ADDITION) -->
    <div class="section" id="add-fee">
        <h4>â• Add New Fee</h4>

        <form method="POST" action="/add-fees" style="display:flex;gap:15px;flex-wrap:wrap;">
            <input type="hidden" name="member_id" value="{{ member.id }}">

            <input
                type="number"
                name="amount"
                placeholder="Enter fee amount (â‚¹)"
                required
                style="padding:12px;border-radius:8px;border:1px solid rgba(255,107,53,.4);
                       background:rgba(0,0,0,.3);color:#fff;min-width:200px;"
            >

            <button type="submit" class="btn-primary">ğŸ’° Add Fee</button>
        </form>

        <p style="color:#a0a0a0;margin-top:10px;font-size:.9em;">
            Next due date will be auto set (30 days)
        </p>
    </div>

    <!-- PAYMENT HISTORY & STATUS -->
    {% if fees %}
    <div class="section">
        <h4>ğŸ’³ Payment History & Status</h4>
        <div class="recent-list">
            {% for fee in fees %}
            <div class="list-item" style="justify-content:space-between;align-items:center;
                {% if fee.paid_status == 'pending' %}
                    border-left:4px solid #ffc107;background:rgba(255,193,7,.15);
                {% elif fee.paid_status == 'paid' %}
                    border-left:4px solid #4caf50;
                {% endif %}
            ">
                <div>
                    <span style="display:block;color:#ff6b35;font-weight:bold;">â‚¹{{ fee.amount|int }}</span>
                    <span style="display:block;color:#a0a0a0;font-size:0.9em;">Due: {{ fee.next_due }}</span>
                </div>
                <div style="text-align:right;">
                    <span style="display:block;padding:5px 12px;border-radius:6px;
                        {% if fee.paid_status == 'pending' %}
                            background:#ffc107;color:#000;font-weight:bold;
                        {% else %}
                            background:#4caf50;color:#fff;font-weight:bold;
                        {% endif %}
                    ">{{ fee.paid_status|upper }}</span>
                    {% if fee.paid_status == 'pending' %}
                    <form action="/pay-fees/{{ member.id }}" method="POST" style="margin-top:8px;">
                        <button type="submit" class="btn-primary" style="padding:6px 12px;font-size:0.85em;">âœ… Mark Paid</button>
                    </form>
                    {% endif %}
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
    {% else %}
    <div class="section">
        <h4>ğŸ’³ Payment History</h4>
        <p style="color:#a0a0a0;text-align:center;">No fees added yet</p>
    </div>
    {% endif %}

    <!-- FITNESS GOAL SECTION -->
    <div class="section" id="goal-section" style="background:rgba(76,175,80,.1);border:1px solid rgba(76,175,80,.3);">
        <h4 style="color:#4caf50;">ğŸ¯ Fitness Goal</h4>
        
        {% if goal %}
        <!-- Display Current Goal -->
        <div style="background:rgba(0,0,0,.3);border-radius:10px;padding:20px;margin-bottom:20px;">
            <div class="info-row" style="border:none;">
                <span>Goal Type</span>
                <span style="color:#4caf50;font-weight:bold;">{{ 'ğŸ“ˆ Weight Gain' if goal.goal_type == 'weight_gain' else 'ğŸ“‰ Weight Loss' }}</span>
            </div>
            <div class="info-row" style="border:none;">
                <span>Target Weight</span>
                <span style="color:#4caf50;font-weight:bold;">{{ goal.target_weight }} kg</span>
            </div>
            <div class="info-row" style="border:none;">
                <span>Deadline</span>
                <span style="color:#4caf50;font-weight:bold;">{{ goal.deadline }}</span>
            </div>
            {% if weight_logs %}
                {% set current_weight = weight_logs[0].weight %}
                {% set difference = current_weight - goal.target_weight %}
                <div class="info-row" style="border:none;">
                    <span>Progress</span>
                    <span style="color:{% if goal.goal_type == 'weight_loss' and difference <= 0 %}#4caf50{% elif goal.goal_type == 'weight_gain' and difference >= 0 %}#4caf50{% else %}#ff6b35{% endif %};font-weight:bold;">
                        {% if difference == 0 %}ğŸ‰ Target Reached!{% elif difference < 0 %}{{ difference|abs }} kg remaining{% else %}{{ difference }} kg away{% endif %}
                    </span>
                </div>
                {% set progress_percentage = ((goal.target_weight - member.start_weight)|abs / (current_weight - member.start_weight)|abs * 100) if (current_weight - member.start_weight) != 0 else 0 %}
                <div style="margin-top:15px;">
                    <div style="background:rgba(0,0,0,.3);border-radius:10px;height:20px;overflow:hidden;">
                        <div style="background:linear-gradient(90deg,#4caf50,#66bb6a);height:100%;width:{{ [progress_percentage, 100]|min }}%;transition:width 0.3s ease;"></div>
                    </div>
                    <p style="color:#a0a0a0;font-size:0.85em;margin-top:8px;">Progress: {{ [progress_percentage, 100]|min|int }}%</p>
                </div>
            {% endif %}
        </div>
        
        <!-- Update Goal Form -->
        <form method="POST" action="/set-goal/{{ member.id }}" style="display:flex;flex-direction:column;gap:12px;">
            <h5 style="color:#4caf50;margin-top:15px;">Update Goal</h5>
            <div style="display:flex;gap:12px;flex-wrap:wrap;">
                <select name="goal_type" required style="padding:10px;border-radius:6px;border:1px solid rgba(76,175,80,.4);background:rgba(0,0,0,.3);color:#fff;flex:1;min-width:150px;">
                    <option value="weight_loss" {% if goal and goal.goal_type == 'weight_loss' %}selected{% endif %}>ğŸ“‰ Weight Loss</option>
                    <option value="weight_gain" {% if goal and goal.goal_type == 'weight_gain' %}selected{% endif %}>ğŸ“ˆ Weight Gain</option>
                </select>
                <input type="number" name="target_weight" placeholder="Target Weight (kg)" step="0.5" required style="padding:10px;border-radius:6px;border:1px solid rgba(76,175,80,.4);background:rgba(0,0,0,.3);color:#fff;flex:1;min-width:150px;" value="{{ goal.target_weight if goal else '' }}">
                <input type="date" name="deadline" required style="padding:10px;border-radius:6px;border:1px solid rgba(76,175,80,.4);background:rgba(0,0,0,.3);color:#fff;flex:1;min-width:150px;" value="{{ goal.deadline if goal else '' }}">
                <button type="submit" class="btn-primary" style="background:linear-gradient(135deg,#4caf50,#66bb6a);padding:10px 20px;">ğŸ’¾ Update Goal</button>
            </div>
        </form>
        {% else %}
        <!-- Set New Goal Form -->
        <form method="POST" action="/set-goal/{{ member.id }}" style="display:flex;flex-direction:column;gap:12px;">
            <p style="color:#a0a0a0;margin-bottom:10px;">No goal set yet. Create one now!</p>
            <div style="display:flex;gap:12px;flex-wrap:wrap;">
                <select name="goal_type" required style="padding:10px;border-radius:6px;border:1px solid rgba(76,175,80,.4);background:rgba(0,0,0,.3);color:#fff;flex:1;min-width:150px;">
                    <option value="">Select Goal Type</option>
                    <option value="weight_loss">ğŸ“‰ Weight Loss</option>
                    <option value="weight_gain">ğŸ“ˆ Weight Gain</option>
                </select>
                <input type="number" name="target_weight" placeholder="Target Weight (kg)" step="0.5" required style="padding:10px;border-radius:6px;border:1px solid rgba(76,175,80,.4);background:rgba(0,0,0,.3);color:#fff;flex:1;min-width:150px;">
                <input type="date" name="deadline" required style="padding:10px;border-radius:6px;border:1px solid rgba(76,175,80,.4);background:rgba(0,0,0,.3);color:#fff;flex:1;min-width:150px;">
                <button type="submit" class="btn-primary" style="background:linear-gradient(135deg,#4caf50,#66bb6a);padding:10px 20px;">ğŸ¯ Set Goal</button>
            </div>
        </form>
        {% endif %}
    </div>

    <!-- WEIGHT TRACKING SECTION -->
    <div class="section" id="weight-section">
        <h4>âš–ï¸ Weight Tracking & Progress</h4>
        
        <!-- Add Weight Form -->
        <form method="POST" action="/add-weight" style="display:flex;gap:15px;flex-wrap:wrap;margin-bottom:25px;">
            <input type="hidden" name="member_id" value="{{ member.id }}">
            
            <input
                type="number"
                name="weight"
                placeholder="Enter weight (kg)"
                step="0.5"
                required
                style="padding:12px;border-radius:8px;border:1px solid rgba(255,107,53,.4);
                       background:rgba(0,0,0,.3);color:#fff;min-width:150px;"
            >
            
            <button type="submit" class="btn-primary">â• Log Weight</button>
        </form>

        <!-- Weight History -->
        {% if weight_logs %}
        <div style="background:rgba(0,0,0,.2);border-radius:10px;padding:15px;">
            <h5 style="color:#ff6b35;margin-bottom:15px;">ğŸ“Š Weight History</h5>
            <div class="recent-list">
                {% set start_weight = member.start_weight %}
                {% for log in weight_logs %}
                    {% set difference = log.weight - start_weight %}
                    {% set status = 'ğŸ“‰ Lost' if difference < 0 else 'ğŸ“ˆ Gained' if difference > 0 else 'âœ… Same' %}
                    <div class="list-item" style="justify-content:space-between;align-items:center;border-left:4px solid {% if difference < 0 %}#4caf50{% elif difference > 0 %}#ff6b35{% else %}#ffc107{% endif %};">
                        <div>
                            <span style="display:block;color:#fff;font-weight:bold;">{{ log.month }}</span>
                            <span style="display:block;color:#a0a0a0;font-size:0.9em;">Weight: {{ log.weight }} kg</span>
                        </div>
                        <div style="text-align:right;">
                            <span style="display:block;font-weight:bold;color:{% if difference < 0 %}#4caf50{% elif difference > 0 %}#ff6b35{% else %}#ffc107{% endif %};">{{ status }} {{ difference|abs }} kg</span>
                        </div>
                    </div>
                {% endfor %}
            </div>
        </div>
        {% else %}
        <p style="color:#a0a0a0;text-align:center;">No weight logs yet. Start tracking now!</p>
        {% endif %}

        <!-- Weight Summary -->
        {% if weight_logs %}
        <div style="background:rgba(255,107,53,.1);border-radius:10px;padding:15px;margin-top:15px;">
            <h5 style="color:#ff6b35;margin-bottom:10px;">ğŸ“ˆ Summary</h5>
            <div class="info-row" style="border:none;">
                <span>Starting Weight</span>
                <span style="color:#ff6b35;font-weight:bold;">{{ member.start_weight }} kg</span>
            </div>
            <div class="info-row" style="border:none;">
                <span>Current Weight</span>
                <span style="color:#ff6b35;font-weight:bold;">{{ weight_logs[0].weight }} kg</span>
            </div>
            <div class="info-row" style="border:none;">
                <span>Total Progress</span>
                {% set total_change = weight_logs[0].weight - member.start_weight %}
                <span style="color:{% if total_change < 0 %}#4caf50{% elif total_change > 0 %}#ff6b35{% else %}#ffc107{% endif %};font-weight:bold;">
                    {% if total_change < 0 %}ğŸ“‰ -{{ total_change|abs }} kg{% elif total_change > 0 %}ğŸ“ˆ +{{ total_change }} kg{% else %}âœ… No change{% endif %}
                </span>
            </div>
        </div>
        {% endif %}
    </div>

    <footer>
        <p>ğŸ’ª Consistency builds champions</p>
        <p>&copy; 2025 FitZone</p>
    </footer>

    {% else %}
    <p style="text-align:center;color:#a0a0a0;">Member not found</p>
    {% endif %}

</div>
</body>
</html>